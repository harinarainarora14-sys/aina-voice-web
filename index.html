<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Aina ‚Ä¢ Mood + Voice Assistant</title>
  <style>
    :root {
      --bg:#0b1020; --card:#121a33; --ink:#e7ebf3; --muted:#cfd8f3;
      --btn:#0c1329; --btn-br:rgba(255,255,255,.12);
      --glow1:#7c9cff; --glow2:#b9e0ff;
    }
    *{box-sizing:border-box;}
    html,body{height:100%;margin:0;font-family:system-ui,sans-serif;color:var(--ink);}
    body{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:24px;gap:24px;background:var(--bg);min-height:100vh;}
    .wrap{width:100%;max-width:1100px;display:flex;gap:24px;flex-wrap:wrap;justify-content:center;align-items:flex-start;}
    .wrap.solo{justify-content:center;}
    .wrap.solo .card#moodCard{max-width:640px;width:100%;}
    .card{background:var(--card);border-radius:16px;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,.35);flex:1;min-width:300px;max-width:500px;}
    h1{margin:0 0 10px;font-size:22px;}
    .sub{opacity:.8;font-size:14px;margin-bottom:14px;}
    button{background:var(--btn);color:var(--ink);border:1px solid var(--btn-br);padding:10px 14px;border-radius:12px;cursor:pointer;font-size:14px;transition:transform .15s ease,border-color .15s ease;}
    button:hover{transform:scale(1.05);border-color:var(--glow1);}
    button[disabled]{opacity:.6;cursor:not-allowed;transform:none;}
    input[type="text"]{width:100%;padding:12px;border-radius:12px;border:1px solid var(--btn-br);background:var(--btn);color:var(--ink);outline:none;}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;}
    .result{margin-top:14px;font-size:16px;line-height:1.6;}
    .glow-text{font-weight:600;font-size:18px;background:linear-gradient(90deg,var(--glow1),var(--glow2),var(--glow1));-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent;animation:glow 3s infinite alternate;}
    @keyframes glow{from{text-shadow:0 0 10px var(--glow1),0 0 20px var(--glow1);}to{text-shadow:0 0 20px var(--glow2),0 0 30px var(--glow1);}}
    .exercise{margin-top:8px;font-size:15px;color:var(--muted);text-shadow:0 0 8px rgba(124,156,255,.5);}
    .modebar{display:flex;gap:8px;margin:8px 0 12px;align-items:center;}
    .modebar button.active{border-color:var(--glow1);transform:scale(1.03);}
    .panel{display:none;}
    .panel.show{display:block;}
    .answer{min-height:48px;}
    .hint{font-size:12px;opacity:.75;margin-top:6px;}
    #toggleVoice{position:fixed;bottom:20px;right:20px;z-index:1001;background:var(--card);border:1px solid var(--btn-br);border-radius:20px;padding:10px 16px;box-shadow:0 4px 12px rgba(0,0,0,.4);}
    #toggleVoice.pulse{animation:pulse 1.6s infinite;border-color:var(--glow1);}
    @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(124,156,255,0.12);}70%{box-shadow:0 0 0 8px rgba(124,156,255,0.02);}100%{box-shadow:0 0 0 0 rgba(124,156,255,0.0);}}
    #iosUnlockBtn{position:fixed;top:40%;left:50%;transform:translate(-50%,-50%);padding:20px 30px;border-radius:14px;border:none;background:var(--glow1);color:#000;font-weight:600;font-size:16px;display:none;z-index:2000;}

    /* blackout */
    #blackoutOverlay{position:fixed;top:0;left:0;width:100%;height:100%;background:black;z-index:1000;display:none;}
    #blackoutToggle{position:fixed;top:20px;left:20px;z-index:2001;background:#ff4d4d;color:#fff;font-weight:600;padding:10px 16px;border:none;border-radius:12px;cursor:pointer;}
  </style>
</head>
<body>
<div id="blackoutOverlay"></div>
<button id="blackoutToggle">Blackout</button>

<div class="wrap" id="mainWrap">
  <!-- Mood -->
  <div class="card" id="moodCard">
    <h1>Mood Detector</h1>
    <div class="sub">Analyze your facial expression for 4 seconds.</div>
    <div class="row"><button id="startMood">Start</button></div>
    <div id="moodResult" class="result">Press Start to analyze your mood.</div>
    <video id="video" autoplay muted playsinline style="display:none"></video>
    <canvas id="overlay" style="display:none"></canvas>
  </div>
  <!-- Voice -->
  <div class="card" id="voiceCard">
    <h1>Voice Assistant</h1>
    <div class="sub">Ask by typing, single voice shot, or continuous conversation.</div>
    <div class="modebar">
      <button id="mText" class="active">Text Mode</button>
      <button id="mVoice">Voice Chat</button>
      <button id="mCont">Voice Continuous</button>
      <div style="flex:1"></div>
      <button id="stopAll">‚èπ Stop</button>
    </div>
    <div id="panelText" class="panel show">
      <div class="row" style="margin-bottom:8px;width:100%">
        <input id="textIn" type="text" placeholder="Type your message‚Ä¶" />
        <button id="sendBtn">Send</button>
      </div>
      <div class="hint">Auto-speaks every reply. ‚ÄúStop‚Äù cancels speech.</div>
    </div>
    <div id="panelVoice" class="panel"><div class="row"><button id="startVoice">üé§ Start Listening</button></div></div>
    <div id="panelCont" class="panel"><div class="row"><button id="startCont">üîÑ Start Continuous</button></div></div>
    <div id="answer" class="result answer">Ask something by text or voice.</div>
  </div>
</div>

<button id="toggleVoice">Hide Assistant</button>
<button id="iosUnlockBtn">Tap to Enable Speech</button>

<script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.min.js"></script>
<script>
const API_URL="https://voice-assistant-api-yya9.onrender.com/ask";
let audioUnlocked=false,speechQueue=[];const isIOS=/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream;const iosBtn=document.getElementById('iosUnlockBtn');
function speak(t){if(!t)return;if(isIOS&&!audioUnlocked){speechQueue.push(t);iosBtn.style.display='block';return;}speechSynthesis.cancel();let u=new SpeechSynthesisUtterance(t);speechSynthesis.speak(u);}
function stopSpeaking(){speechSynthesis.cancel();}
if(isIOS){iosBtn.onclick=()=>{speechSynthesis.speak(new SpeechSynthesisUtterance(""));audioUnlocked=true;iosBtn.style.display='none';while(speechQueue.length)speak(speechQueue.shift());};}

const mText=document.getElementById('mText'),mVoice=document.getElementById('mVoice'),mCont=document.getElementById('mCont');
const panelText=document.getElementById('panelText'),panelVoice=document.getElementById('panelVoice'),panelCont=document.getElementById('panelCont');
const stopAllBtn=document.getElementById('stopAll'),answerEl=document.getElementById('answer');
const textIn=document.getElementById('textIn'),sendBtn=document.getElementById('sendBtn');
let rec=null,contModeActive=false;
function setMode(w){[mText,mVoice,mCont].forEach(b=>b.classList.remove('active'));[panelText,panelVoice,panelCont].forEach(p=>p.classList.remove('show'));
  if(w==='text'){mText.classList.add('active');panelText.classList.add('show');stopVoiceRec();}
  if(w==='voice'){mVoice.classList.add('active');panelVoice.classList.add('show');stopVoiceRec();}
  if(w==='cont'){mCont.classList.add('active');panelCont.classList.add('show');startContinuous();}
}
mText.onclick=()=>setMode('text');mVoice.onclick=()=>setMode('voice');mCont.onclick=()=>setMode('cont');
async function ask(q){if(!q.trim())return;stopSpeaking();answerEl.textContent="Thinking‚Ä¶";
  try{let r=await fetch(API_URL+"?question="+encodeURIComponent(q));let d=await r.json();let txt=d?.answer||"No answer";answerEl.innerHTML=`<span class="glow-text">${txt}</span>`;speak(txt);}
  catch{answerEl.textContent="Error with API";}}
function sendText(){let q=textIn.value.trim();if(!q)return;ask(q);textIn.value="";}
textIn.onkeydown=e=>{if(e.key==='Enter'){e.preventDefault();sendText();}};sendBtn.onclick=sendText;
function newRecognizer(c){const SR=window.SpeechRecognition||window.webkitSpeechRecognition;if(!SR){alert("No SR");return;}
  let r=new SR();r.lang="en-US";r.continuous=c;r.onresult=e=>{for(let i=e.resultIndex;i<e.results.length;i++){if(e.results[i].isFinal){ask(e.results[i][0].transcript.trim());}}};
  r.onend=()=>{if(c&&contModeActive)setTimeout(()=>{try{r.start();}catch{}},250)};return r;}
const startVoice=document.getElementById('startVoice');startVoice.onclick=()=>{stopVoiceRec();rec=newRecognizer(false);if(rec)rec.start();}
const startCont=document.getElementById('startCont');function startContinuous(){stopVoiceRec();contModeActive=true;rec=newRecognizer(true);if(rec)rec.start();}
startCont.onclick=startContinuous;function stopVoiceRec(){contModeActive=false;if(rec)try{rec.stop();}catch{}rec=null;}stopAllBtn.onclick=()=>{stopVoiceRec();stopSpeaking();};

const video=document.getElementById('video'),moodResult=document.getElementById('moodResult'),startMoodBtn=document.getElementById('startMood');let stream=null;
async function loadModels(){await Promise.all([faceapi.nets.tinyFaceDetector.loadFromUri("https://cdn.jsdelivr.net/gh/vladmandic/face-api/model/"),faceapi.nets.faceExpressionNet.loadFromUri("https://cdn.jsdelivr.net/gh/vladmandic/face-api/model/")]);}
async function startCamera(){if(!stream){stream=await navigator.mediaDevices.getUserMedia({video:true});video.srcObject=stream;await video.play();}}
async function analyzeMood(){await startCamera();moodResult.textContent="Analyzing‚Ä¶";startMoodBtn.disabled=true;setTimeout(()=>{moodResult.textContent="Mood analysis done.";startMoodBtn.disabled=false;},4000);}
startMoodBtn.onclick=analyzeMood;loadModels();

const toggleBtn=document.getElementById('toggleVoice'),mainWrap=document.getElementById('mainWrap'),voiceCard=document.getElementById('voiceCard');let hidden=false;
function updateToggleUI(){toggleBtn.textContent=hidden?"Show Assistant":"Hide Assistant";voiceCard.style.display=hidden?"none":"block";mainWrap.classList.toggle("solo",hidden);}
toggleBtn.onclick=()=>{hidden=!hidden;updateToggleUI();};updateToggleUI();

// Blackout auto-resume
const blackoutOverlay=document.getElementById('blackoutOverlay');const blackoutToggle=document.getElementById('blackoutToggle');let blackout=false;
blackoutToggle.onclick=()=>{blackout=!blackout;
  if(blackout){blackoutOverlay.style.display='block';blackoutToggle.textContent="Restore";stopVoiceRec();stopSpeaking();if(stream){stream.getTracks().forEach(t=>t.stop());stream=null;}}
  else{blackoutOverlay.style.display='none';blackoutToggle.textContent="Blackout";startCamera();if(mCont.classList.contains('active'))startContinuous();}
};

// mouse remap
document.addEventListener('contextmenu',e=>{e.preventDefault();analyzeMood();});
document.addEventListener('click',e=>{if(e.detail===1)startVoice.click();});
document.addEventListener('dblclick',()=>stopAllBtn.click());
</script>
</body>
</html>

